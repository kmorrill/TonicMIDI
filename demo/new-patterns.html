<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Colorful Chord Swell + Evolving Drum Demo</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 1rem;
        background: #f0f0f0;
      }
      fieldset {
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        padding: 1rem;
      }
      label {
        display: inline-block;
        width: 150px;
        font-weight: 600;
      }
      #output {
        width: 100%;
        height: 200px;
        background: #fff;
        border: 1px solid #ccc;
        padding: 8px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-size: 0.9rem;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>ColorfulChordSwell & EvolvingLockedDrum Demo</h1>
    <p>
      <strong>Note:</strong> This demo uses an <em>external MIDI clock</em>.
      Press <strong>Play</strong> on your DAW or hardware to start. Make sure
      you have a MIDI input device providing clock to your browser.
    </p>

    <fieldset>
      <legend>Chord Swell Pattern</legend>
      <label for="colorSelect">Color:</label>
      <select id="colorSelect">
        <option value="warm" selected>Warm</option>
        <option value="bright">Bright</option>
        <option value="dark">Dark</option>
        <option value="mysterious">Mysterious</option>
      </select>
      <br />

      <label for="swellDuration">swellDuration:</label>
      <input type="number" id="swellDuration" min="1" max="64" value="16" />
      <br />

      <label for="overlap">overlap:</label>
      <input type="number" id="overlap" min="-8" max="8" value="2" />
      <br />

      <label for="chordComplexity">chordComplexity (0..1):</label>
      <input
        type="range"
        id="chordComplexity"
        min="0"
        max="1"
        step="0.1"
        value="0.5"
      />
      <br />

      <button id="updateChordBtn">Update Chord Pattern</button>
    </fieldset>

    <fieldset>
      <legend>Evolving Drum Pattern</legend>
      <label for="drumIntensity">drumIntensity (0..1):</label>
      <input
        type="range"
        id="drumIntensity"
        min="0"
        max="1"
        step="0.1"
        value="0.5"
      />
      <br />

      <label for="flavorSelect">flavor:</label>
      <select id="flavorSelect">
        <option value="ambient" selected>ambient</option>
        <option value="tribal">tribal</option>
        <option value="electronic">electronic</option>
        <option value="lofi">lofi</option>
      </select>
      <br />

      <button id="updateDrumsBtn">Update Drum Pattern</button>
    </fieldset>

    <fieldset>
      <legend>Energy Manager Controls</legend>
      <div>
        <button data-hype="low">Set Hype: LOW</button>
        <button data-hype="medium">Set Hype: MEDIUM</button>
        <button data-hype="full">Set Hype: full</button>
      </div>
      <div style="margin-top: 0.5rem">
        <button data-tension="none">Set Tension: NONE</button>
        <button data-tension="low">Set Tension: LOW</button>
        <button data-tension="mid">Set Tension: MID</button>
        <button data-tension="high">Set Tension: HIGH</button>
      </div>
    </fieldset>

    <h2>Console Output</h2>
    <div id="output"></div>

    <script type="module">
      /*******************************************************
       * 1) Import createDefaultSystem + patterns, etc.
       *******************************************************/
      import { createDefaultSystem } from "../src/system/create-default-system.js";
      import {
        LiveLoop,
        ColorfulChordSwellPattern,
        EvolvingLockedDrumPattern,
      } from "../src/index.js"; // or do more fine-grained imports

      // Utility to mirror console logs to #output
      const outputEl = document.getElementById("output");
      const origLog = console.log;
      console.log = (...args) => {
        origLog(...args);
        outputEl.textContent += args.join(" ") + "\n";
        outputEl.scrollTop = outputEl.scrollHeight;
      };

      /*******************************************************
       * 2) Main async function to set up system, patterns, loops
       *******************************************************/
      (async function main() {
        // Create the default system (MIDI bus, device manager, transport, etc.)
        const system = await createDefaultSystem();

        // For convenience:
        const {
          transport,
          energyManager,
          chordManager,
          globalContext,
          midiOutputs,
        } = system;
        chordManager.authorizeProvider("ColorfulChordSwellPattern"); // so chord pattern can set chords

        // A) Create an initial chord pattern
        let chordPattern = new ColorfulChordSwellPattern({
          color: "warm",
          swellDuration: 16,
          overlap: 2,
          chordComplexity: 0.5,
        });

        // B) Create the chord loop
        const chordLoop = new LiveLoop(system.midiBus, {
          pattern: chordPattern,
          midiChannel: 8,
          name: "ColorfulChordLoop",
          role: "chordProvider",
          globalContext,
          // Pass device info if you like. If you want chord LFO automation, etc.
          deviceManager: system.deviceManager,
          midiOutputId: midiOutputs[0]?.id,
        });

        // C) Create a drum pattern that includes a deviceDefinition
        let drumPattern = new EvolvingLockedDrumPattern({
          patternLength: 16,
          drumIntensity: 0.5,
          flavor: "ambient",
          // This is crucial: the pattern code does nameâ†’note,
          // so it needs the deviceDefinition from the appropriate device output
          deviceDefinition: system.deviceManager.getDeviceForOutput(
            midiOutputs[0]?.id
          ),
        });

        // D) Create the drum loop
        const drumLoop = new LiveLoop(system.midiBus, {
          pattern: drumPattern,
          midiChannel: 1,
          name: "EvolvingDrums",
          role: "kickProvider",
          globalContext,
          deviceManager: system.deviceManager,
          midiOutputId: midiOutputs[0]?.id,
        });

        // E) Add both loops
        transport.addLiveLoop(chordLoop);
        transport.addLiveLoop(drumLoop);

        // Ready message
        console.log("System ready! Press Play on external clock...");

        /*******************************************************
         * 3) Hook up UI for chord + drum config
         *******************************************************/
        const colorSelect = document.getElementById("colorSelect");
        const swellDurationInput = document.getElementById("swellDuration");
        const overlapInput = document.getElementById("overlap");
        const chordComplexityInput = document.getElementById("chordComplexity");

        document
          .getElementById("updateChordBtn")
          .addEventListener("click", () => {
            const newColor = colorSelect.value;
            const newSwellDuration =
              parseInt(swellDurationInput.value, 10) || 16;
            const newOverlap = parseInt(overlapInput.value, 10) || 0;
            const newComplex = parseFloat(chordComplexityInput.value) || 0.5;

            chordPattern = new ColorfulChordSwellPattern({
              color: newColor,
              swellDuration: newSwellDuration,
              overlap: newOverlap,
              chordComplexity: newComplex,
            });
            chordLoop.setPattern(chordPattern, true);
            console.log(
              "ChordSwell updated:",
              newColor,
              newSwellDuration,
              newOverlap,
              newComplex
            );
          });

        const drumIntensityRange = document.getElementById("drumIntensity");
        const flavorSelect = document.getElementById("flavorSelect");
        document
          .getElementById("updateDrumsBtn")
          .addEventListener("click", () => {
            const newIntensity = parseFloat(drumIntensityRange.value);
            const newFlavor = flavorSelect.value;

            // Recreate the pattern with updated parameters (and pass deviceDefinition again)
            drumPattern = new EvolvingLockedDrumPattern({
              patternLength: 16,
              drumIntensity: newIntensity,
              flavor: newFlavor,
              deviceDefinition: system.deviceManager.getDeviceForOutput(
                midiOutputs[0]?.id
              ),
            });
            drumLoop.setPattern(drumPattern, true);

            console.log("Drum updated:", newIntensity, newFlavor);
          });

        // F) Hook up hype/tension
        document.querySelectorAll("button[data-hype]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const newHype = btn.getAttribute("data-hype");
            system.energyManager.setHypeLevel(newHype);
            console.log("EnergyManager setHypeLevel:", newHype);
          });
        });
        document.querySelectorAll("button[data-tension]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const newTension = btn.getAttribute("data-tension");
            system.energyManager.setTensionLevel(newTension);
            console.log("EnergyManager setTensionLevel:", newTension);
          });
        });
      })();
    </script>
  </body>
</html>
