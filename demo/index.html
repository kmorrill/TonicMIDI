<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>OP-XY Live: Multi-Pattern Demo</title>
    <style>
      /* Base styling to achieve a clean, professional look */
      body {
        font-family: "Segoe UI", Tahoma, sans-serif;
        margin: 1rem auto;
        max-width: 980px;
        background: #f7f7f7;
        line-height: 1.5;
        color: #333;
      }
      h1,
      h2,
      h3,
      legend {
        color: #222;
      }
      h1 {
        margin-bottom: 0.2rem;
      }
      p {
        margin-top: 0.2rem;
        margin-bottom: 1rem;
      }
      fieldset {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        background: #fff;
      }
      fieldset legend {
        font-weight: 600;
        padding: 0 0.5rem;
      }
      .description {
        font-size: 0.9rem;
        margin-bottom: 1rem;
        color: #555;
      }
      .param-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.7rem;
      }
      .param-row label {
        display: inline-block;
        min-width: 200px;
        font-weight: 600;
      }
      .param-row select,
      .param-row input[type="number"],
      .param-row input[type="range"],
      .param-row input[type="text"] {
        flex: 1;
        padding: 0.3rem;
        font-size: 0.9rem;
        margin-left: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .param-help {
        display: block;
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.2rem;
      }
      button {
        display: inline-block;
        cursor: pointer;
        background: #0077cc;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.4rem 1rem;
        font-size: 0.9rem;
        margin-top: 0.5rem;
        transition: background 0.2s;
      }
      button:hover {
        background: #005fa3;
      }
      .energy-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .energy-buttons button {
        margin: 0;
      }
      .small-note {
        font-size: 0.85rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>OP-XY Live: Multi-Pattern Demo</h1>
    <p>
      <strong>Updated Introduction / YouTube Demo Script</strong><br />
      Welcome to this demonstration of our DAWless, mobile-friendly setup
      powering an advanced sequencing system for the Teenage Engineering OP-XY.
      In this video, we'll explore how you can harness multiple generative
      patterns—<em>without needing deep music theory</em>—by simply adjusting
      "Hype" and "Tension" controls.
    </p>
    <p>
      These concepts draw inspiration from <em>The Addiction Formula</em>, a
      book that emphasizes how effective music arrangements often hinge on
      intentional rises and falls in energy. "Hype" increases the intensity,
      bringing in faster subdivisions or more layers; "Tension" introduces
      dissonance or borrowed chords that heighten the musical suspense. Even if
      you're not familiar with those terms from the book, you'll see how easily
      they let you shape your track’s arrangement from a single mobile page.
    </p>
    <p>
      <strong>Script Outline for the YouTube Video:</strong><br /><br />
      <strong>1. Introduction:</strong><br />
      &bull; Greet viewers and explain that we have a web-based system
      controlling a multi-timbral OP-XY synthesizer/drum machine. Emphasize no
      DAW is required and everything runs on an Android phone for maximum
      portability.<br />
      &bull; Mention that the patterns (ColorfulChordSwell, EvolvingLockedDrum,
      and PhraseContourMelody) adapt to chord changes and user input in real
      time.
      <br /><br />
      <strong>2. Explanation of Patterns and Controls:</strong><br />
      &bull; Show how <em>ColorfulChordSwell</em> handles chord progressions
      with overlapping transitions—like in a film soundtrack—just by changing
      color, swell duration, and complexity.<br />
      &bull; Demonstrate <em>EvolvingLockedDrum</em> as it injects percussive
      variety without losing the core rhythmic drive.<br />
      &bull; Showcase <em>PhraseContourMelody</em>, how it automatically forms
      melodic arcs over multiple bars, shaped by sub-sections (e.g. "intro",
      "build", "peak", "resolve").<br />
      &bull; Clarify that "Hype" adds more layers or faster patterns, while
      "Tension" brings in dissonant notes, borrowed chords, or extra drum hits
      to keep things interesting.<br /><br />
      <strong>3. Hands-On Demonstration:</strong><br />
      &bull; Connect your Android phone to the OP-XY via USB or MIDI adapter—no
      computer needed. Press "Play" on the phone’s webpage to follow the
      external clock from the OP-XY or another hardware clock.<br />
      &bull; Turn up "Hype" to show instant changes, where drums get punchier
      and chords become more active.<br />
      &bull; Increase "Tension" during a breakdown to add dissonant chord
      extensions or approach notes in the melody. Show how easy it is to revert
      to less tension for a resolution.<br /><br />
      <strong>4. Customizing Patterns on the Fly:</strong><br />
      &bull; Demonstrate adjusting the chord color, overlap, or melodic density.
      Note how each change is immediate, letting you improvise an entire track
      live.<br />
      &bull; Emphasize that you can do this all from your phone’s browser, with
      no special hardware beyond the OP-XY and a USB MIDI cable.<br /><br />
      <strong>5. Wrap-Up:</strong><br />
      &bull; Summarize the freedom of jamming portably, referencing the
      <em>Addiction Formula</em> principle that it’s easy to keep listeners
      engaged by controlling hype and tension.<br />
      &bull; Encourage viewers to experiment with these patterns and approach
      their next arrangement with a more creative, dynamic lens.<br /><br />
      That’s it! Now let’s dive into the parameters below to see how you can
      adjust everything for your own unique performance.
    </p>

    <p class="small-note">
      <strong>Note:</strong> This demo relies on an
      <em>external MIDI clock</em>. Press <strong>Play</strong> on your OP-XY or
      external hardware to start. Ensure you have a MIDI input device sending
      clock to the browser.
    </p>

    <!-- 1) Colorful Chord Swell Pattern -->
    <fieldset>
      <legend>Colorful Chord Swell Pattern</legend>
      <p class="description">
        Generates a rich harmonic progression with overlapping chords. Perfect
        for ambient swells or transitions. Reacts to your hype/tension settings.
      </p>

      <div class="param-row">
        <label for="colorSelect">
          <span>Color (Scale Mode)</span>
          <span class="param-help">
            Chooses the modal flavor: <em>warm</em> (Ionian),
            <em>bright</em> (Lydian), <em>dark</em> (Aeolian),
            <em>mysterious</em> (Phrygian).
          </span>
        </label>
        <select id="colorSelect">
          <option value="warm" selected>Warm (Ionian)</option>
          <option value="bright">Bright (Lydian)</option>
          <option value="dark">Dark (Aeolian)</option>
          <option value="mysterious">Mysterious (Phrygian)</option>
        </select>
      </div>

      <div class="param-row">
        <label for="swellDuration">Swell Duration (steps):</label>
        <input type="number" id="swellDuration" min="1" max="64" value="16" />
        <span class="param-help">
          How many steps each chord is held before moving to the next. Larger
          values produce slower chord changes.
        </span>
      </div>

      <div class="param-row">
        <label for="overlap">Overlap (steps):</label>
        <input type="number" id="overlap" min="-8" max="8" value="2" />
        <span class="param-help">
          Positive overlap means chords overlap by this many steps. Negative
          values introduce a gap between chords.
        </span>
      </div>

      <div class="param-row">
        <label for="chordComplexity">Chord Complexity (0..1):</label>
        <input
          type="range"
          id="chordComplexity"
          min="0"
          max="1"
          step="0.1"
          value="0.5"
        />
        <span class="param-help">
          Controls how extended/dissonant chords can become. 0 = simple triads,
          1 = richly extended chords (#11, 13, etc.).
        </span>
      </div>

      <button id="updateChordBtn">Update Chord Pattern</button>
    </fieldset>

    <!-- 2) EvolvingLockedDrum Pattern -->
    <fieldset>
      <legend>Evolving Drum Pattern</legend>
      <p class="description">
        A continually changing drum pattern that retains an overall identity.
        It's the designated <strong>kick provider</strong>, syncing your groove
        with hype/tension changes.
      </p>
      <div class="param-row">
        <label for="drumIntensity">Drum Intensity (0..1):</label>
        <input
          type="range"
          id="drumIntensity"
          min="0"
          max="1"
          step="0.1"
          value="0.5"
        />
        <span class="param-help">
          Higher intensity increases the frequency and volume of additional
          hits.
        </span>
      </div>
      <div class="param-row">
        <label for="flavorSelect">Flavor:</label>
        <select id="flavorSelect">
          <option value="ambient" selected>Ambient</option>
          <option value="tribal">Tribal</option>
          <option value="electronic">Electronic</option>
          <option value="lofi">Lo-Fi</option>
        </select>
        <span class="param-help">
          Selects a fundamental style. E.g., <em>ambient</em> uses fewer hits,
          <em>tribal</em> focuses on toms/percussion, <em>electronic</em> might
          add extra syncopation, etc.
        </span>
      </div>
      <button id="updateDrumsBtn">Update Drum Pattern</button>
    </fieldset>

    <!-- 3) PhraseContourMelody Pattern -->
    <fieldset>
      <legend>PhraseContourMelody (Melody on channel 5)</legend>
      <p class="description">
        Builds multi-bar melodic phrases subdivided into sections (e.g. "intro",
        "build", "peak", "resolve"). Each sub-section shapes pitch direction,
        duration, and velocity. Also responds to tension/hype.
      </p>

      <div class="param-row">
        <label for="phraseBars">Phrase Bars:</label>
        <input type="number" id="phraseBars" min="1" max="16" value="4" />
        <span class="param-help">
          Number of bars in a single phrase cycle. Each phrase is subdivided by
          <em>subSections</em>.
        </span>
      </div>

      <div class="param-row">
        <label for="subSections">SubSections (comma-separated):</label>
        <input
          type="text"
          id="subSections"
          value="intro,build,peak,resolve,cadence"
          size="30"
        />
        <span class="param-help">
          Possible values (examples): intro, build, peak, resolve, cadence,
          fall, bridge, etc. The pattern changes logic based on each section’s
          name.
        </span>
      </div>

      <div class="param-row">
        <label for="stepsPerBar">Steps Per Bar:</label>
        <input type="number" id="stepsPerBar" min="4" max="64" value="16" />
        <span class="param-help">
          The total sequencer steps that define one bar. 16 is typical in 4/4
          when each step = 16th note.
        </span>
      </div>

      <div class="param-row">
        <label for="cadenceBeats">Cadence Beats:</label>
        <input type="number" id="cadenceBeats" min="0" max="8" value="2" />
        <span class="param-help">
          How many beats at the end of the phrase are used for a "cadence" hold
          or rest. E.g., 2 beats at the end can create a sense of resolution.
        </span>
      </div>

      <div class="param-row">
        <label for="melodicDensity">Melodic Density (0..1):</label>
        <input
          type="range"
          id="melodicDensity"
          min="0"
          max="1"
          step="0.1"
          value="0.7"
        />
        <span class="param-help">
          Probability of placing a note at each possible slot. Higher = busier
          melody.
        </span>
      </div>

      <div class="param-row">
        <label for="baseVelocity">Base Velocity (1..127):</label>
        <input type="number" id="baseVelocity" min="1" max="127" value="90" />
        <span class="param-help">
          Central MIDI velocity for the melody. Sub-sections and hype can push
          this up or down.
        </span>
      </div>

      <div class="param-row">
        <label for="tensionEmbellishProb">Tension Embellish (0..1):</label>
        <input
          type="range"
          id="tensionEmbellishProb"
          min="0"
          max="1"
          step="0.1"
          value="0.2"
        />
        <span class="param-help">
          Base probability of adding approach/dissonance notes. This scales with
          the current tension level.
        </span>
      </div>

      <button id="updateMelodyBtn">Update Melody Pattern</button>
    </fieldset>

    <!-- 4) Energy Manager Controls -->
    <fieldset>
      <legend>Energy Manager Controls</legend>
      <p class="description">
        Dynamically control <strong>Hype</strong> (low, medium, high) and
        <strong>Tension</strong> (none, low, mid, high). Patterns will adjust
        their output accordingly.
      </p>
      <div class="energy-buttons">
        <button data-hype="low">Set Hype: LOW</button>
        <button data-hype="medium">Set Hype: MEDIUM</button>
        <button data-hype="high">Set Hype: HIGH</button>
      </div>
      <div class="energy-buttons" style="margin-top: 0.5rem">
        <button data-tension="none">Set Tension: NONE</button>
        <button data-tension="low">Set Tension: LOW</button>
        <button data-tension="mid">Set Tension: MID</button>
        <button data-tension="high">Set Tension: HIGH</button>
      </div>
    </fieldset>

    <script type="module">
      /****************************************************
       * 1) Import system + patterns
       ****************************************************/
      import { createDefaultSystem } from "../src/system/create-default-system.js";
      import {
        LiveLoop,
        ColorfulChordSwellPattern,
        EvolvingLockedDrumPattern,
        PhraseContourMelody,
      } from "../src/index.js";

      /****************************************************
       * 2) Main async function: set up system, patterns, loops
       ****************************************************/
      (async function main() {
        // 2A) Create the system (MIDI Bus, Transport, etc.)
        const system = await createDefaultSystem();
        const {
          transport,
          energyManager,
          chordManager,
          globalContext,
          midiOutputs,
        } = system;

        // Insert references so patterns can read chord/tension/hype
        globalContext.energyManager = energyManager;
        globalContext.chordManager = chordManager;

        // Authorize a chord provider ID for chordManager
        chordManager.authorizeProvider("ColorfulChordSwellPattern");

        // (1) Build initial chord pattern + loop
        let chordPattern = new ColorfulChordSwellPattern({
          color: "warm",
          swellDuration: 16,
          overlap: 2,
          chordComplexity: 0.5,
        });
        const chordLoop = new LiveLoop(system.midiBus, {
          pattern: chordPattern,
          midiChannel: 8,
          name: "ColorfulChordLoop",
          role: "chordProvider",
          globalContext,
          deviceManager: system.deviceManager,
          midiOutputId: midiOutputs[0]?.id,
        });

        // (2) Build initial drum pattern + loop (kick provider)
        let drumPattern = new EvolvingLockedDrumPattern({
          patternLength: 16,
          drumIntensity: 0.5,
          flavor: "ambient",
          deviceDefinition: system.deviceManager.getDeviceForOutput(
            midiOutputs[0]?.id
          ),
        });
        const drumLoop = new LiveLoop(system.midiBus, {
          pattern: drumPattern,
          midiChannel: 1,
          name: "EvolvingDrums",
          role: "kickProvider",
          globalContext,
          deviceManager: system.deviceManager,
          midiOutputId: midiOutputs[0]?.id,
        });

        // (3) Build initial PhraseContourMelody + loop (channel=5)
        let melodyPattern = new PhraseContourMelody({
          phraseBars: 4,
          subSections: ["intro", "build", "peak", "resolve", "cadence"],
          stepsPerBar: 16,
          cadenceBeats: 2,
          melodicDensity: 0.7,
          baseVelocity: 90,
          tensionEmbellishProb: 0.2,
        });
        const melodyLoop = new LiveLoop(system.midiBus, {
          pattern: melodyPattern,
          midiChannel: 5,
          name: "PhraseMelody",
          role: null,
          globalContext,
          deviceManager: system.deviceManager,
          midiOutputId: midiOutputs[0]?.id,
        });

        // Add loops to transport
        transport.addLiveLoop(chordLoop);
        transport.addLiveLoop(drumLoop);
        transport.addLiveLoop(melodyLoop);

        // (A) Chord Swell controls
        const colorSelect = document.getElementById("colorSelect");
        const swellDurationInput = document.getElementById("swellDuration");
        const overlapInput = document.getElementById("overlap");
        const chordComplexityInput = document.getElementById("chordComplexity");

        document
          .getElementById("updateChordBtn")
          .addEventListener("click", () => {
            const newColor = colorSelect.value;
            const newSwell = parseInt(swellDurationInput.value, 10) || 16;
            const newOverlap = parseInt(overlapInput.value, 10) || 0;
            const newComplex = parseFloat(chordComplexityInput.value) || 0.5;

            chordPattern = new ColorfulChordSwellPattern({
              color: newColor,
              swellDuration: newSwell,
              overlap: newOverlap,
              chordComplexity: newComplex,
            });
            chordLoop.setPattern(chordPattern, true);
          });

        // (B) Drum pattern controls
        const drumIntensityRange = document.getElementById("drumIntensity");
        const flavorSelect = document.getElementById("flavorSelect");

        document
          .getElementById("updateDrumsBtn")
          .addEventListener("click", () => {
            const newIntensity = parseFloat(drumIntensityRange.value) || 0.5;
            const newFlavor = flavorSelect.value;

            drumPattern = new EvolvingLockedDrumPattern({
              patternLength: 16,
              drumIntensity: newIntensity,
              flavor: newFlavor,
              deviceDefinition: system.deviceManager.getDeviceForOutput(
                midiOutputs[0]?.id
              ),
            });
            drumLoop.setPattern(drumPattern, true);
          });

        // (C) PhraseContourMelody controls
        const phraseBarsEl = document.getElementById("phraseBars");
        const subSectionsEl = document.getElementById("subSections");
        const stepsPerBarEl = document.getElementById("stepsPerBar");
        const cadenceBeatsEl = document.getElementById("cadenceBeats");
        const melodicDensityEl = document.getElementById("melodicDensity");
        const baseVelocityEl = document.getElementById("baseVelocity");
        const tensionEmbellishEl = document.getElementById(
          "tensionEmbellishProb"
        );

        document
          .getElementById("updateMelodyBtn")
          .addEventListener("click", () => {
            const pb = parseInt(phraseBarsEl.value, 10) || 4;
            const subsArray = subSectionsEl.value
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s.length > 0);
            const spb = parseInt(stepsPerBarEl.value, 10) || 16;
            const cadBeats = parseFloat(cadenceBeatsEl.value) || 2;
            const density = parseFloat(melodicDensityEl.value) || 0.7;
            const baseVel = parseInt(baseVelocityEl.value, 10) || 90;
            const tProb = parseFloat(tensionEmbellishEl.value) || 0.2;

            melodyPattern = new PhraseContourMelody({
              phraseBars: pb,
              subSections:
                subsArray.length > 0 ? subsArray : ["build", "peak", "resolve"],
              stepsPerBar: spb,
              cadenceBeats: cadBeats,
              melodicDensity: density,
              baseVelocity: baseVel,
              tensionEmbellishProb: tProb,
            });
            melodyLoop.setPattern(melodyPattern, true);
          });

        // (D) Hype/Tension controls
        document.querySelectorAll("button[data-hype]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const newHype = btn.getAttribute("data-hype");
            energyManager.setHypeLevel(newHype);
          });
        });
        document.querySelectorAll("button[data-tension]").forEach((btn) => {
          btn.addEventListener("click", () => {
            const newTension = btn.getAttribute("data-tension");
            energyManager.setTensionLevel(newTension);
          });
        });
      })();
    </script>
  </body>
</html>
